[{"id":"cb46f622.b72e38","type":"tab","label":"Validate CF Publish State","disabled":false,"info":""},{"id":"e2a66267.cca19","type":"inject","z":"cb46f622.b72e38","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":100,"y":140,"wires":[["11557a74.d8ada6"]]},{"id":"dc0792de.a6c5d","type":"function","z":"cb46f622.b72e38","name":"Parse CFs","func":"let pubUrls = []\nmsg.lastReps = new Map()\nfor (let i = 0; i < msg.payload.hits.length; i++) {\n    uri = msg.payload.hits[i][\"jcr:path\"]\n    curRepState = msg.payload.hits[i][\"cq:lastReplicationAction\"]\n    \n    if (curRepState !== \"Activate\") {\n        console.log(`${uri} => NOT_PUBLISHED`)\n    } else {\n        pubUrls.push(`http://${msg.publishHostAndPort}${uri}.json`)\n        msg.lastReps.set(uri, msg.payload.hits[i][\"jcr:lastModified\"])\n    }\n}\nmsg.payload = pubUrls\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":570,"y":340,"wires":[["4a6fe429.4d7d8c"]]},{"id":"8223af79.825d9","type":"http request","z":"cb46f622.b72e38","name":"Find CFs","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":620,"y":140,"wires":[["ddba864.9950e78","bfbe3b64.c63458"]]},{"id":"4a6fe429.4d7d8c","type":"split","z":"cb46f622.b72e38","name":"Split CF Results","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":780,"y":340,"wires":[["b0d6d4d8.b0ed58"]]},{"id":"b0d6d4d8.b0ed58","type":"change","z":"cb46f622.b72e38","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":340,"wires":[["f51c89a6.92c8f8"]]},{"id":"f51c89a6.92c8f8","type":"http request","z":"cb46f622.b72e38","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":560,"y":420,"wires":[["88d0f39f.4e4b5"]]},{"id":"b2a7d7ef.28a8b8","type":"function","z":"cb46f622.b72e38","name":"Compare Timestamps","func":"// TODO: rewrite to match the URI with a grouping pattern\nlet selfPath = msg.url.replace(`http://${msg.publishHostAndPort}`, \"\").replace(\".json\", \"\")\n\nif (msg.lastReps.has(selfPath)) {\n  // compare\n  let authorDate = new Date(msg.lastReps.get(selfPath))\n  let publishDate = new Date(msg.payload[\"jcr:lastModified\"])\n  if (authorDate.toString() === publishDate.toString()) {\n      console.log(`${selfPath} => IN_SYNC`)\n  } else {\n      console.log(`${selfPath} => OUT_OF_DATE`)\n  }\n} else {\n  console.log(`No entry found for key: ${selfPath}`)\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":910,"y":420,"wires":[["53b36253.412efc"]]},{"id":"88d0f39f.4e4b5","type":"json","z":"cb46f622.b72e38","name":"","property":"payload","action":"","pretty":false,"x":720,"y":420,"wires":[["b2a7d7ef.28a8b8"]]},{"id":"b43c1b1c.e208c8","type":"http in","z":"cb46f622.b72e38","name":"/api/cf/publish-diff","url":"/api/cf/publish-diff","method":"get","upload":false,"swaggerDoc":"","x":100,"y":60,"wires":[["11557a74.d8ada6"]]},{"id":"53b36253.412efc","type":"debug","z":"cb46f622.b72e38","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1130,"y":420,"wires":[]},{"id":"11557a74.d8ada6","type":"change","z":"cb46f622.b72e38","name":"","rules":[{"t":"set","p":"pageSize","pt":"msg","to":"5","tot":"num"},{"t":"set","p":"authorHostAndPort","pt":"msg","to":"localhost:4502","tot":"str"},{"t":"set","p":"publishHostAndPort","pt":"msg","to":"localhost:4503","tot":"str"},{"t":"set","p":"user","pt":"msg","to":"admin","tot":"str"},{"t":"set","p":"pass","pt":"msg","to":"admin","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":260,"y":140,"wires":[["6cf2a113.3b081"]]},{"id":"6cf2a113.3b081","type":"function","z":"cb46f622.b72e38","name":"Dynamic URL","func":"msg.pagerOffset = 0\nmsg.url = `http://${msg.authorHostAndPort}/bin/querybuilder.json?path=/content/dam&2_property=jcr:primaryType&2_property.value=dam:AssetContent&1_property=contentFragment&1_property.value=true&p.hits=full&p.nodedepth=1&p.limit=5&p.guessTotal=true&p.offset=0`\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":140,"wires":[["8223af79.825d9"]]},{"id":"ddba864.9950e78","type":"function","z":"cb46f622.b72e38","name":"Pager","func":"let resp = JSON.parse(msg.payload)\n\nif (resp.more) {\n    msg.pagerOffset = msg.pagerOffset + msg.pageSize\n    msg.url = `http://${msg.authorHostAndPort}/bin/querybuilder.json?path=/content/dam&2_property=jcr:primaryType&2_property.value=dam:AssetContent&1_property=contentFragment&1_property.value=true&p.nodedepth=1&p.hits=full&p.limit=5&p.guessTotal=true&p.offset=${msg.pagerOffset}`\n    console.log(`Next page: ${msg.url}`)\n    return [msg,msg];\n\n} else {\n  console.log('Done processing pages') \n  return null\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":610,"y":220,"wires":[["8223af79.825d9"]]},{"id":"bfbe3b64.c63458","type":"json","z":"cb46f622.b72e38","name":"","property":"payload","action":"","pretty":false,"x":790,"y":140,"wires":[["dc0792de.a6c5d"]]},{"id":"804cbea.c65c64","type":"http response","z":"cb46f622.b72e38","name":"","statusCode":"","headers":{},"x":1130,"y":480,"wires":[]}]