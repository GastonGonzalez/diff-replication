[{"id":"348a7ec7.4640b2","type":"tab","label":"Compare CFs","disabled":false,"info":""},{"id":"b2171408.8d3328","type":"tab","label":"Sample Pager Flow","disabled":false,"info":""},{"id":"cb46f622.b72e38","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"c463fcc8.59e87","type":"inject","z":"348a7ec7.4640b2","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":440,"y":240,"wires":[["43697d10.5565f4"]]},{"id":"67bf0096.62277","type":"function","z":"348a7ec7.4640b2","name":"Parse CFs","func":"let pubUrls = []\nlet cfState = []\nmsg.lastReps = new Map()\nfor (let i = 0; i < msg.payload.hits.length; i++) {\n    uri = msg.payload.hits[i][\"jcr:path\"]\n    curRepState = msg.payload.hits[i][\"cq:lastReplicationAction\"]\n    \n    if (curRepState !== \"Activate\") {\n      console.log(`${uri} => NOT_PUBLISHED`)\n      cfState.push({\n          uri: uri,\n          status: \"NOT_PUBLISHED\"\n      })\n    } else {\n        pubUrls.push('http://localhost:4503' + uri + '.json' )\n        msg.lastReps.set(uri, msg.payload.hits[i][\"jcr:lastModified\"])\n    }\n}\nmsg.payload = pubUrls\nmsg.cfState = cfState\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":300,"wires":[["cafda218.6d501"]]},{"id":"43697d10.5565f4","type":"http request","z":"348a7ec7.4640b2","name":"Find CFs","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://localhost:4502/bin/querybuilder.json?path=/content/dam&2_property=jcr:primaryType&2_property.value=dam:AssetContent&1_property=contentFragment&1_property.value=true&p.hits=full&p.nodedepth=1&p.limit=100&p.guessTotal=true","tls":"","persist":false,"proxy":"","authType":"basic","x":630,"y":240,"wires":[["dcc2429b.d1ca8"]]},{"id":"cafda218.6d501","type":"split","z":"348a7ec7.4640b2","name":"Split CF Results","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":650,"y":300,"wires":[["d63ccede.1a487"]]},{"id":"dcc2429b.d1ca8","type":"json","z":"348a7ec7.4640b2","name":"","property":"payload","action":"","pretty":false,"x":770,"y":240,"wires":[["67bf0096.62277"]]},{"id":"d63ccede.1a487","type":"change","z":"348a7ec7.4640b2","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":300,"wires":[["ad8d743a.2e02a8"]]},{"id":"ad8d743a.2e02a8","type":"http request","z":"348a7ec7.4640b2","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":430,"y":380,"wires":[["2d260744.d0efe8"]]},{"id":"4a26ce18.87486","type":"function","z":"348a7ec7.4640b2","name":"Compare Timestamps","func":"// TODO: rewrite to match the URI with a grouping pattern\nlet selfPath = msg.url.replace(\"http://localhost:4503\", \"\").replace(\".json\", \"\")\n\nlet status = \"UNKNOWN\"\nif (msg.lastReps.has(selfPath)) {\n  // compare\n  let authorDate = new Date(msg.lastReps.get(selfPath))\n  let publishDate = new Date(msg.payload[\"jcr:lastModified\"])\n  if (authorDate.toString() === publishDate.toString()) {\n      console.log(`${selfPath} => IN_SYNC`)\n      status = \"IN_SYNC\"\n  } else {\n      console.log(`${selfPath} => OUT_OF_DATE`)\n      sttaus = \"OUT_OF_DATE\"\n  }\n} else {\n  console.log(`No entry found for key: ${selfPath}`)\n}\nmsg.cfState.push({\n    uri: selfPath,\n    status: status\n})\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":780,"y":380,"wires":[["315915fe.e563ea"]]},{"id":"2d260744.d0efe8","type":"json","z":"348a7ec7.4640b2","name":"","property":"payload","action":"","pretty":false,"x":590,"y":380,"wires":[["4a26ce18.87486"]]},{"id":"dd9ef5b2.3d7338","type":"http in","z":"348a7ec7.4640b2","name":"/api/cf/publish-diff","url":"/api/cf/publish-diff","method":"get","upload":false,"swaggerDoc":"","x":440,"y":180,"wires":[["43697d10.5565f4"]]},{"id":"634cb2c4.94deec","type":"csv","z":"348a7ec7.4640b2","name":"","sep":",","hdrin":"","hdrout":"once","multi":"one","ret":"\\n","temp":"uri,status","skip":"0","strings":true,"include_empty_strings":"","include_null_values":"","x":670,"y":620,"wires":[["757da1cf.894ec"]]},{"id":"757da1cf.894ec","type":"file","z":"348a7ec7.4640b2","name":"","filename":"out.csv","appendNewline":true,"createDir":false,"overwriteFile":"false","encoding":"none","x":820,"y":620,"wires":[[]]},{"id":"be8bb742.a15708","type":"debug","z":"348a7ec7.4640b2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":810,"y":560,"wires":[]},{"id":"256de11e.2b9cfe","type":"change","z":"348a7ec7.4640b2","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"cfState","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":620,"wires":[["634cb2c4.94deec"]]},{"id":"315915fe.e563ea","type":"join","z":"348a7ec7.4640b2","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":470,"y":500,"wires":[["256de11e.2b9cfe"]]},{"id":"b4883c6a.cb901","type":"inject","z":"b2171408.8d3328","name":"sample data injector","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"data\":[{\"msg\":\"test1\"},{\"msg\":\"test2\"}],\"page\":0,\"pages\":10}","payloadType":"json","x":190,"y":120,"wires":[["af7a3a93.cdc538"]]},{"id":"af7a3a93.cdc538","type":"function","z":"b2171408.8d3328","name":"split message into 2, pager and actual data","func":"var data = { payload: msg.payload.data };\nvar next = { payload: { page: msg.payload.page + 1, pages: msg.payload.pages }};\nreturn [data, next];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":530,"y":200,"wires":[["2ed679c.ea84a86"],["156214ef.645d8b"]]},{"id":"b80cb08.3a0045","type":"debug","z":"b2171408.8d3328","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1190,"y":200,"wires":[]},{"id":"2ed679c.ea84a86","type":"split","z":"b2171408.8d3328","name":"split array into single messages","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":910,"y":200,"wires":[["b80cb08.3a0045"]]},{"id":"156214ef.645d8b","type":"function","z":"b2171408.8d3328","name":"this would be the next fetch (page 2...pages)","func":"if( msg.payload.page < msg.payload.pages ) {\n    var next = { payload: {\n     data: [\n         { msg: \"test3 \"+msg.payload.page },\n         { msg: \"test4 \"+msg.payload.page }\n     ],\n     page: msg.payload.page,\n     pages: msg.payload.pages\n    }}\n    return next;\n    \n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":530,"y":320,"wires":[["af7a3a93.cdc538"]]},{"id":"e2a66267.cca19","type":"inject","z":"cb46f622.b72e38","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":100,"y":140,"wires":[["11557a74.d8ada6"]]},{"id":"dc0792de.a6c5d","type":"function","z":"cb46f622.b72e38","name":"Parse CFs","func":"let pubUrls = []\nmsg.lastReps = new Map()\nfor (let i = 0; i < msg.payload.hits.length; i++) {\n    uri = msg.payload.hits[i][\"jcr:path\"]\n    curRepState = msg.payload.hits[i][\"cq:lastReplicationAction\"]\n    \n    if (curRepState !== \"Activate\") {\n        console.log(`${uri} => NOT_PUBLISHED`)\n    } else {\n        pubUrls.push(`http://${msg.publishHostAndPort}${uri}.json`)\n        msg.lastReps.set(uri, msg.payload.hits[i][\"jcr:lastModified\"])\n    }\n}\nmsg.payload = pubUrls\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":570,"y":340,"wires":[["4a6fe429.4d7d8c"]]},{"id":"8223af79.825d9","type":"http request","z":"cb46f622.b72e38","name":"Find CFs","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":620,"y":140,"wires":[["9689bcbd.f49df","ddba864.9950e78"]]},{"id":"4a6fe429.4d7d8c","type":"split","z":"cb46f622.b72e38","name":"Split CF Results","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":780,"y":340,"wires":[["b0d6d4d8.b0ed58"]]},{"id":"9689bcbd.f49df","type":"json","z":"cb46f622.b72e38","name":"","property":"payload","action":"","pretty":false,"x":810,"y":140,"wires":[["dc0792de.a6c5d"]]},{"id":"b0d6d4d8.b0ed58","type":"change","z":"cb46f622.b72e38","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":340,"wires":[["f51c89a6.92c8f8"]]},{"id":"f51c89a6.92c8f8","type":"http request","z":"cb46f622.b72e38","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":560,"y":420,"wires":[["88d0f39f.4e4b5"]]},{"id":"b2a7d7ef.28a8b8","type":"function","z":"cb46f622.b72e38","name":"Compare Timestamps","func":"// TODO: rewrite to match the URI with a grouping pattern\nlet selfPath = msg.url.replace(`http://${msg.publishHostAndPort}`, \"\").replace(\".json\", \"\")\n\nif (msg.lastReps.has(selfPath)) {\n  // compare\n  let authorDate = new Date(msg.lastReps.get(selfPath))\n  let publishDate = new Date(msg.payload[\"jcr:lastModified\"])\n  if (authorDate.toString() === publishDate.toString()) {\n      console.log(`${selfPath} => IN_SYNC`)\n  } else {\n      console.log(`${selfPath} => OUT_OF_DATE`)\n  }\n} else {\n  console.log(`No entry found for key: ${selfPath}`)\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":910,"y":420,"wires":[["53b36253.412efc"]]},{"id":"88d0f39f.4e4b5","type":"json","z":"cb46f622.b72e38","name":"","property":"payload","action":"","pretty":false,"x":720,"y":420,"wires":[["b2a7d7ef.28a8b8"]]},{"id":"b43c1b1c.e208c8","type":"http in","z":"cb46f622.b72e38","name":"/api/cf/publish-diff","url":"/api/cf/publish-diff","method":"get","upload":false,"swaggerDoc":"","x":100,"y":60,"wires":[[]]},{"id":"53b36253.412efc","type":"debug","z":"cb46f622.b72e38","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1100,"y":420,"wires":[]},{"id":"11557a74.d8ada6","type":"change","z":"cb46f622.b72e38","name":"","rules":[{"t":"set","p":"pagerOffset","pt":"msg","to":"0","tot":"num"},{"t":"set","p":"pageSize","pt":"msg","to":"5","tot":"num"},{"t":"set","p":"authorHostAndPort","pt":"msg","to":"localhost:4502","tot":"str"},{"t":"set","p":"publishHostAndPort","pt":"msg","to":"localhost:4503","tot":"str"},{"t":"set","p":"user","pt":"msg","to":"admin","tot":"str"},{"t":"set","p":"pass","pt":"msg","to":"admin","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":260,"y":140,"wires":[["6cf2a113.3b081"]]},{"id":"6cf2a113.3b081","type":"function","z":"cb46f622.b72e38","name":"Dynamic URL","func":"msg.url = `http://${msg.authorHostAndPort}/bin/querybuilder.json?path=/content/dam&2_property=jcr:primaryType&2_property.value=dam:AssetContent&1_property=contentFragment&1_property.value=true&p.hits=full&p.nodedepth=1&p.limit=5&p.guessTotal=true&p.offset=0`\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":140,"wires":[["8223af79.825d9"]]},{"id":"ddba864.9950e78","type":"function","z":"cb46f622.b72e38","name":"Pager","func":"let resp = JSON.parse(msg.payload)\n\nif (resp.more) {\n    msg.pagerOffset = msg.pagerOffset + msg.pageSize\n    msg.url = `http://${msg.authorHostAndPort}/bin/querybuilder.json?path=/content/dam&2_property=jcr:primaryType&2_property.value=dam:AssetContent&1_property=contentFragment&1_property.value=true&p.nodedepth=1&p.hits=full&p.limit=5&p.guessTotal=true&p.offset=${msg.pagerOffset}`\n    console.log(`Next page: ${msg.url}`)\n    return [msg,msg];\n\n} else {\n  console.log('Done processing pages') \n  return null\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":610,"y":220,"wires":[["8223af79.825d9"]]}]